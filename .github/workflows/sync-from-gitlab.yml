name: Sync from GitLab

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch from GitLab
        run: |
          git remote add gitlab https://git.cubos.io/cubos/kube-templates.git
          git fetch gitlab main

      - name: Check for changes
        id: check
        run: |
          # Check if GitLab has commits that are not in our main branch
          COMMITS_AHEAD=$(git rev-list --count HEAD..gitlab/main)
          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new commits from GitLab"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "gitlab_sha=$(git rev-parse --short gitlab/main)" >> $GITHUB_OUTPUT
            echo "Found $COMMITS_AHEAD new commit(s) from GitLab"
          fi

      - name: Create sync branch and merge
        if: steps.check.outputs.has_changes == 'true'
        id: merge
        run: |
          # Delete remote branch if exists to start fresh
          git push origin --delete sync/gitlab 2>/dev/null || true
          
          git checkout -b sync/gitlab
          if git merge gitlab/main --no-edit --allow-unrelated-histories; then
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            git add -A
            git commit -m "Sync from GitLab (with conflicts to resolve)"
          fi
          git push origin sync/gitlab

      - name: Check for existing PR
        if: steps.check.outputs.has_changes == 'true'
        id: pr_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head sync/gitlab --state open --json number -q '.[0].number' 2>/dev/null || echo "")
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true' && steps.pr_check.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.merge.outputs.has_conflicts }}" == "true" ]; then
            TITLE="‚ö†Ô∏è Sync from GitLab (conflicts)"
            BODY="This PR syncs the latest changes from the upstream GitLab repository.

          **Source:** \`git.cubos.io/cubos/kube-templates\`
          **Latest commit:** \`${{ steps.check.outputs.gitlab_sha }}\`

          ‚ö†Ô∏è **This PR has merge conflicts that need to be resolved manually.**

          ---
          _This PR was created automatically by GitHub Actions._"
            gh pr create --title "$TITLE" --body "$BODY" --base main --head sync/gitlab --label "sync,automated,conflicts"
          else
            TITLE="üîÑ Sync from GitLab"
            BODY="This PR syncs the latest changes from the upstream GitLab repository.

          **Source:** \`git.cubos.io/cubos/kube-templates\`
          **Latest commit:** \`${{ steps.check.outputs.gitlab_sha }}\`

          ---
          _This PR was created automatically by GitHub Actions._"
            gh pr create --title "$TITLE" --body "$BODY" --base main --head sync/gitlab --label "sync,automated"
          fi

      - name: Update existing PR
        if: steps.check.outputs.has_changes == 'true' && steps.pr_check.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR #${{ steps.pr_check.outputs.pr_number }} already exists - branch has been updated with new commits"
